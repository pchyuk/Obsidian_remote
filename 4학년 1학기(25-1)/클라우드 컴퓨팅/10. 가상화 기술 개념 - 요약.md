## 1. 가상화의 기본 개념 및 정의

가상화는 컴퓨터 리소스의 추상화를 일컫는 광범위한 용어로, "물리적인 컴퓨터 리소스의 특징을 다른 시스템, 응용 프로그램, 최종 사용자들이 리소스와 상호작용하는 방식으로부터 감추는 기술"입니다 (Wikipedia). 핵심적으로는 실제 존재하지 않는 하드웨어 플랫폼, 운영체제, 스토리지, 네트워크 등을 가상적으로 제공합니다.

어떤 시스템을 가상화한다는 것은 "가상시스템이 호스트 시스템에서 우리가 기대하는 방식으로 동작하며, 가상시스템에서 일어나는 동작(operation)을 호스트 시스템으로 매핑시키는 함수(function)으로 설명 가능"합니다. 이는 가상화된 게스트 시스템의 상태 전이가 호스트 시스템의 상태 전이로 매핑되는 방식으로 구현됩니다.

## 2. 가상화 대상 시스템 및 매핑 함수 (ABI vs. ISA 레벨)

가상화는 매핑 함수 V의 구현 방식에 따라 ABI(Application Binary Interface) 레벨과 ISA(Instruction Set Architecture) 레벨로 구분됩니다.

### ABI 레벨 가상화 (프로세스 가상머신):
- 소프트웨어 애플리케이션 관점에서 시스템을 가상화합니다.
- "대표적 예: JVM(Java Virtual Machine)"이며, 자바 애플리케이션은 JVM만 있으면 하위 시스템에 상관없이 동작합니다.
- 이러한 형태의 가상머신을 런타임(runtime)이라고도 합니다.

- 프로세스 가상머신은 Multiprogramed System, Emulator, Same ISA Binary Optimizer, High Level Language Virtual Machine의 4가지 타입으로 세분화됩니다. 
- 특히 Emulator는 인터프리터 방식과 바이너리 트랜슬레이터 방식으로 나뉘며, "인스트럭션을 하나씩 해석하여 수행"하는 인터프리터 방식은 느리지만 오버헤드가 없고, "소스 인스트럭션을 블럭단위로 변환하여 수행"하는 바이너리 트랜슬레이터 방식은 빠르지만 스타트업 오버헤드가 존재합니다.

### ISA 레벨 가상화 (시스템 가상머신)
- "명령어 집합(instruction set)에 대한 가상화"를 의미합니다.
- 가상머신 모니터(Virtual Machine Monitor, VMM)라고도 불리며, 1960년대 후반부터 사용된 용어입니다.
- 하드웨어 시스템과 일반적인 소프트웨어 사이에 위치합니다.

## 3. 하이퍼바이저의 이해

하이퍼바이저는 "가상화 소프트웨어" 또는 "가상머신 모니터"를 의미하며, 가상머신을 관리하는 핵심 요소입니다.

### 용어 정의:
- **호스트 머신(host machine)**: 하이퍼바이저가 설치되는 물리 시스템.
- **게스트 머신(guest machine)**: 하이퍼바이저가 관리하는 가상머신.

### 하이퍼바이저 타입
- 물리 시스템에 직접 설치되는지 여부에 따라 타입 1과 타입 2로 나뉩니다. "하이퍼바이저는 2개의 타입으로 명확하게 구분되는 것은 아니다. 예를 들어, KVM과 FreeGSD의 bhybe는 커널 모듈로 호스트 운영체제를 타입 1 하이퍼바이저로 변환시킨다. 동시에 리눅스 배포판과 FreeBSD는 범용 운영체제이기 때문에 KVM과 bhyve도 타입 2 하이퍼바이저로 분류될 수 있다 (Wikipedia)."

### 타입 1 하이퍼바이저 (베어 메탈)
- "물리시스템 하드웨어에 직접 설치되어 가상머신을 관리"합니다.
- KVM, Xen이 대표적입니다.
- "물리시스템의 운영체제 역할을 수행"하며, 대규모 클라우드 컴퓨팅 서비스를 위해 도입됩니다.
- "클라우드 서비스의 신속한 확장과 축소가 가능하도록 확장성(scalability)을 보장"하며, "가상머신과 호스트머신간 빠른 통신이 가능"합니다.
- Intel의 VT-x (vmx flag)와 AMD의 AMD-V (svm flag)와 같은 "물리시스템의 하드웨어적 가상화 지원"을 활용합니다.

### 타입 2 하이퍼바이저 (Hosted)
- "호스트머신의 운영체제 위에서 마치 애플리케이션처럼 설치"됩니다.
- 가상머신을 단일 물리 시스템에 설치하고 운영하는 데 편리하지만, "호스트머신의 하드웨어에 직접 접근이 어려움"과 "타입 1 하이퍼바이저 대비 오버헤드 발생"이라는 단점이 있습니다.

### 대표적인 하이퍼바이저
- **KVM (Kernel-based Virtual Machine)**: 공개 소프트웨어 기반 하이퍼바이저로, "리눅스 커널 모듈로 작동"합니다. QEMU(Quick Emulator)는 I/O 에뮬레이션을 위해 KVM과 함께 사용됩니다.
- **Xen**: 케임브리지 대학의 연구 프로젝트로 시작되었으며, "반가상화(paravirtualization) 하이퍼바이저로 시작"했으나, 현재는 전가상화와 하드웨어 지원을 받는 타입 1 하이퍼바이저입니다. "도메인(domain) 개념을 도입하여 특권레벨을 구분"하는데, 물리 시스템 장치에 접근 가능한 특권 도메인(Dom 0)과 일반 가상머신인 게스트 도메인(Dom U)으로 나뉩니다. 게스트 도메인은 하이퍼콜(hypercall)을 통해 장치에 접근합니다.

### 하이퍼바이저의 라이프 사이클 (Intel VT-x 기준)
- VMXON: VMX 명령 실행 단계 진입.
- VMM은 "vmx의 루트모드(root)에서 동작"하고, "가상머신은 비루트(non-root) 모드에서 실행"됩니다.
- VM Entries: 루트 모드에서 비루트 모드로 전환(VMRESUME, VMLAUNCH 명령).
- VM Exit: 비루트 모드에서 루트 모드로 전환. VM Exit이 발생하면 제어권이 VMM으로 넘어가고, VMM은 원인 정보를 VMCS(Virtual Machine Control Structure)에 저장합니다.
- VMCS는 여러 가상머신에 대한 상태를 저장하며, 메모리상에 존재하고 가상머신별로 존재합니다. 컨텍스트 스위칭 시 VMCS에 정보가 저장됩니다.
- VMXOFF: VMM 종료.

## 4. 클라우드 서비스에서의 가상화

가상화는 클라우드 서비스에서 다양한 장점을 제공합니다.

### 장점
- "적은 컴퓨팅 리소스 하드웨어 구매로 비용 절감(reduced spending)".
- "쉬운 백업과 재해복구(easier backup and disaster recovery)".
- "중단 없는 비즈니스(better business continuity)".
- "효율적인 IT 운영(more efficient IT operations)".

### 단점
- "가상화 소프트웨어 및 가상화 지원 하드웨어 구매로 초기 투자비용 발생(upfront costs)".
- "소프트웨어 라이선스 비용 발생(software licensing considerations)".
- "초기 교육 필요(possible learning curve)".

## 5. 가상화 타입 (전가상화, 반가상화, 하이브리드, OS 레벨)

가상화는 "게스트 운영체제의 수정 여부에 따라 전가상화 vs. 반가상화로 구분"되며, 하드웨어 지원 여부도 중요한 구분 기준입니다. 하이퍼바이저는 게스트 운영체제보다 높은 특권 레벨(Ring 0)에서 수행되어야 합니다.

### 전가상화 (Full Virtualization)
- "게스트 OS 변경없이 가상머신에 탑재"되며, "게스트 OS는 가상화 환경에서 동작하고 있는지 인지하지 못합니다."
- 게스트 OS가 하드웨어 관련 명령어를 직접 요청하면 하이퍼바이저가 이를 처리하여 오버헤드가 발생할 수 있습니다.

### 소프트웨어 기반 전가상화
- "바이너리 트랜슬레이션(binary translation)" 방식을 사용합니다.
- 게스트 OS가 Ring 1로 이동하고 하이퍼바이저가 Ring 0에 위치하며, 게스트 OS의 특권 명령(nonvirtualizable instruction)은 하이퍼바이저에 의해 새로운 명령 셋으로 변환되어 하드웨어에 전달됩니다. 이때 트랩(trap)이 발생합니다.
- 트랩은 사용자 프로그램에서 발생하는 시스템 콜, 인터럽트는 하드웨어에서 발생하는 비동기적 이벤트, 익셉션은 CPU에서 발생하는 오류(폴트/어보트)를 의미합니다.
- VMWare가 개발한 방식으로, 구현이 까다롭고 오버헤드가 발생합니다.

### 하드웨어 기반 전가상화
- Intel VT-x, AMD-V와 같은 "CPU 벤더들이 가상화를 지원하기 위한 새로운 기능을 탑재"하여 "바이너리 트랜슬레이션을 제거하고 가상화 기술이 구현된 하드웨어가 직접 수행"합니다.
- 게스트 OS가 비루트 모드(Ring 0)에서 동작하고 하이퍼바이저는 루트 모드(Ring 0보다 높은 권한)에서 실행됩니다.
- 민감한 요청 발생 시 하이퍼바이저로 트랩이 발생합니다.

### 반가상화 (Paravirtualization)
- "소프트웨어적 전가상화의 단점을 보완하기 위해 Xen에서 고안"되었습니다.
- "게스트 OS는 자신이 가상화 환경에서 실행되고 있는 것을 인지"하며, "게스트 OS를 수정하여 하이퍼바이저와 통신할 수 있는 API를 추가"합니다. 따라서 "게스트 OS 소스코드가 공개되어야" 하므로 주로 리눅스가 사용됩니다.
- "반가상화는 가상화를 지원하는 하드웨어에서도 동작 가능"하며, "하드웨어 지원 가상화가 반드시 전가상화만을 의미하지 않음"을 강조합니다.
- **장점**: 특히 타이머 관리와 같이 성능 개선이 필요한 경우 "게스트 OS를 수정 → 아이들 코드 블록에 하이퍼바이저에게 특정시간 후에 타이머 인터럽트를 생성하도록 요청하는 코드 추가"와 같은 방식으로 오버헤드를 줄일 수 있습니다.
- **단점**: "가상 CPU 핸들링의 어려움"이 있습니다. 물리 CPU와 동작 방식이 다를 수 있어 모든 상황을 고려한 커널 개발이 비효율적입니다 (예: CPUID 명령 처리).

### 하이브리드 가상화 (Hybrid Virtualization)
- 하드웨어 기반 가상화의 성능 제약(특히 I/O나 메모리 집약형 작업)을 보완하기 위해 "반가상화와 하드웨어 기반 가상화를 조합한 방식"입니다.
- 하드웨어 지원 가상화를 기본으로 사용하되, "I/O 집약형 작업에 반가상화의 네트워크와 디스크 드라이버를 사용하여 성능 차이 해소"합니다. (예: VMware ESXi에서 RDMA를 통해 VMkernel을 우회)

### 운영체제 레벨 가상화 (OS Level Virtualization)
- "일반적으로 컨테이너화(containerization)으로 불립니다."
- 운영체제에 컨테이너 엔진을 설치하고 컨테이너를 가상머신처럼 관리하는 방식입니다.
- 하이퍼바이저와 가장 큰 차이점은 "운영체제의 공유 여부"입니다. "모든 컨테이너는 운영체제를 공유"하며, 따라서 서로 다른 운영체제를 사용하는 컨테이너는 동일 호스트에서 실행될 수 없습니다.
- "리눅스 시스템의 리소스를 분리(isolation) 하는 기술에 기반"하며, chroot(1979년)와 같은 기술도 포함됩니다. 광의적으로 가상화로 분류되기도 합니다.